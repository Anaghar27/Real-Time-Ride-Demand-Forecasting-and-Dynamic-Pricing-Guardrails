services:
  postgres:
    image: postgres:16
    container_name: rt_postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    ports:
      - "${POSTGRES_PORT}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - rt_platform

  mlflow:
    image: python:3.11-slim
    container_name: rt_mlflow
    restart: unless-stopped
    environment:
      MLFLOW_BACKEND_STORE_URI: postgresql+psycopg2://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
      MLFLOW_ARTIFACT_ROOT: /mlflow/artifacts
    command: >
      /bin/sh -c "pip install --no-cache-dir mlflow==2.20.1 psycopg2-binary==2.9.10 &&
      mlflow server
      --host 0.0.0.0
      --port 5000
      --backend-store-uri $$MLFLOW_BACKEND_STORE_URI
      --serve-artifacts
      --artifacts-destination $$MLFLOW_ARTIFACT_ROOT
      --default-artifact-root mlflow-artifacts:/"
    ports:
      - "5001:5000"
    volumes:
      - mlflow_artifacts:/mlflow/artifacts
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:5000')\""]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 20s
    networks:
      - rt_platform

  api:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: rt_api
    environment:
      PROJECT_NAME: ${PROJECT_NAME}
      ENV: ${ENV}
      LOG_LEVEL: ${LOG_LEVEL}
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      DATABASE_URL: postgresql+psycopg2://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
      MLFLOW_TRACKING_URI: http://mlflow:5000
      API_HOST: 0.0.0.0
      API_PORT: ${API_PORT}
      PREFECT_API_URL: http://prefect:4200/api
      PROMETHEUS_PORT: ${PROMETHEUS_PORT}
      GRAFANA_PORT: ${GRAFANA_PORT}
    command: uvicorn src.api.main:app --host 0.0.0.0 --port ${API_PORT} --reload
    volumes:
      - ..:/app
    working_dir: /app
    ports:
      - "${API_PORT}:${API_PORT}"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:${API_PORT}/health')\""]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - rt_platform

  prefect:
    image: prefecthq/prefect:2-python3.11
    container_name: rt_prefect
    restart: unless-stopped
    command: prefect server start --host 0.0.0.0 --port 4200
    ports:
      - "4200:4200"
    volumes:
      - prefect_data:/root/.prefect
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:4200/api/health')\""]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - rt_platform

  prometheus:
    image: prom/prometheus:latest
    container_name: rt_prometheus
    restart: unless-stopped
    command:
      - --config.file=/etc/prometheus/prometheus.yml
    ports:
      - "${PROMETHEUS_PORT}:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://localhost:9090/-/healthy || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 15s
    networks:
      - rt_platform

  grafana:
    image: grafana/grafana:latest
    container_name: rt_grafana
    restart: unless-stopped
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
    ports:
      - "${GRAFANA_PORT}:3000"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - ./grafana/provisioning/dashboards:/var/lib/grafana/dashboards:ro
    depends_on:
      prometheus:
        condition: service_started
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 20s
    networks:
      - rt_platform

volumes:
  postgres_data:
  mlflow_artifacts:
  prefect_data:
  prometheus_data:
  grafana_data:

networks:
  rt_platform:
    driver: bridge
